<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sərmə ERP - İstehsalat Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        .panel { display: none; animation: fadeIn 0.3s ease-in-out; }
        .panel.active { display: block; }
        .nav-btn { transition: all 0.2s; border-left: 4px solid transparent; }
        .nav-btn:hover { background-color: #f8fafc; }
        .nav-btn.active { background-color: #eff6ff; border-left-color: #3b82f6; color: #1d4ed8; }
        .stock-card { transition: transform 0.2s; }
        .stock-card:hover { transform: translateY(-2px); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        /* Qablaşma inputları üçün xüsusi stil */
        .pkg-input { font-size: 11px; padding: 4px 8px; height: 34px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col md:flex-row">

    <div id="toast" class="fixed top-5 right-5 z-50 transform transition-all duration-300 translate-x-full opacity-0"></div>

    <aside class="w-full md:w-64 bg-white shadow-lg z-20 flex-shrink-0">
        <div class="p-6 border-b border-slate-100 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-blue-200 shadow-lg">S</div>
            <div>
                <h1 class="font-bold text-lg leading-tight">SƏRMƏ ERP</h1>
                <div id="dbStatus" class="text-[10px] font-bold text-orange-400 uppercase tracking-wider flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-orange-400 animate-pulse"></span> Qoşulur...
                </div>
            </div>
        </div>
        <nav class="p-4 space-y-2">
            <button onclick="showPanel('stock')" id="nav-stock" class="nav-btn active w-full text-left p-3 rounded-r-lg font-medium flex items-center gap-3 text-slate-600">
                <i class="fas fa-boxes w-6 text-center"></i> Anbar & Stok
            </button>
            <button onclick="showPanel('separator')" id="nav-separator" class="nav-btn w-full text-left p-3 rounded-r-lg font-medium flex items-center gap-3 text-slate-600">
                <i class="fas fa-filter w-6 text-center"></i> Seperator
            </button>
            <button onclick="showPanel('production')" id="nav-production" class="nav-btn w-full text-left p-3 rounded-r-lg font-medium flex items-center gap-3 text-slate-600">
                <i class="fas fa-industry w-6 text-center"></i> İstehsalat
            </button>
            <button onclick="showPanel('prod_history')" id="nav-prod_history" class="nav-btn w-full text-left p-3 rounded-r-lg font-medium flex items-center gap-3 text-slate-600">
                <i class="fas fa-clipboard-list w-6 text-center"></i> İstehsal Tarixçəsi
            </button>
            <button onclick="showPanel('logs')" id="nav-logs" class="nav-btn w-full text-left p-3 rounded-r-lg font-medium flex items-center gap-3 text-slate-600">
                <i class="fas fa-history w-6 text-center"></i> Ümumi Loglar
            </button>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">

        <div id="panel-stock" class="panel active space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">Xammal Anbarı</h2>
                <button onclick="openStockModal('add')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-200 transition">
                    <i class="fas fa-plus mr-2"></i> Mədaxil
                </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4" id="stockContainer">
                <div class="col-span-full text-center py-10 text-slate-400"><div class="loader mr-2"></div> Yüklənir...</div>
            </div>
        </div>

        <div id="panel-separator" class="panel space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Seperasiya Prosesi</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-blue-800 mb-4 border-b pb-2">1. Giriş Məlumatları</h3>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Stokdakı Süd (Mövcud: <span id="sepStockDisplay" class="text-blue-600">0</span> kq)</label>
                            <input type="number" id="sepInputMilk" class="w-full p-3 border rounded-lg font-bold text-slate-700 focus:ring-2 ring-blue-200 outline-none" placeholder="İstifadə ediləcək miqdar (kq)">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Süd Yağlılıq %</label>
                                <input type="number" id="sepInputFat" class="w-full p-3 border rounded-lg font-bold text-slate-700 outline-none" placeholder="%">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-slate-500 mb-1">İtki (Litr/kq)</label>
                                <input type="number" id="sepInputLoss" value="2" class="w-full p-3 border rounded-lg font-bold text-red-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Alınan Çiyə (kq)</label>
                            <input type="number" id="sepOutputCream" class="w-full p-3 border rounded-lg font-bold text-green-600 outline-none" placeholder="Çıxan çiyə kütləsi">
                        </div>
                        <button onclick="calculateSeparator()" class="w-full py-3 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900 transition">Hesabla</button>
                    </div>
                </div>

                <div id="sepResultBox" class="bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-300 hidden">
                    <h3 class="font-bold text-green-800 mb-4 border-b pb-2">2. Nəticə və Qərar</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-white rounded shadow-sm">
                            <span class="text-slate-500">Çiyə Yağlılığı (Hesablanan):</span>
                            <span id="sepResCreamFat" class="text-2xl font-bold text-green-600">0%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-white rounded shadow-sm">
                            <span class="text-slate-500">Alınan Obrat (Üzsüz - 0%):</span>
                            <span id="sepResSkimQty" class="text-xl font-bold text-slate-700">0 kq</span>
                        </div>
                        <button onclick="commitSeparator()" class="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-lg shadow-green-200">
                            <i class="fas fa-check-circle mr-2"></i> Təsdiqlə və Stoka Vur
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-production" class="panel space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">İstehsalat Planlaması</h2>
            
            <div class="flex gap-4 mb-6">
                <button onclick="setProdMethod('A')" id="btnMethodA" class="flex-1 py-3 px-4 rounded-xl border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold transition">
                    Metod A: Hədəf Məhsul<br><span class="text-xs font-normal text-slate-500">Plan: X kq məhsul</span>
                </button>
                <button onclick="setProdMethod('B')" id="btnMethodB" class="flex-1 py-3 px-4 rounded-xl border-2 border-transparent bg-white text-slate-600 font-bold hover:bg-slate-50 transition">
                    Metod B: Standartlaşdırma<br><span class="text-xs font-normal text-slate-500">Əlimdəkinə nə qədər qatım?</span>
                </button>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-5">
                    
                    <div class="input-group">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Məhsul Adı</label>
                        <select id="prodName" class="w-full p-2 border rounded bg-slate-50 font-bold text-slate-700">
                            <option>Qatıq</option><option>Xama</option><option>Qaymaq</option><option>Pendir</option><option>Şor</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Hədəf Yağ %</label>
                            <input type="number" id="prodTargetFat" class="w-full p-2 border rounded font-bold text-blue-600" placeholder="%">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Yağ Mənbəyi</label>
                            <select id="prodFatSource" class="w-full p-2 border rounded font-bold bg-slate-50 text-sm"></select>
                        </div>
                    </div>

                    <div id="methodA-inputs" class="space-y-4">
                        <div class="input-group relative">
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Planlanan Məhsul (kq)</label>
                            <div class="flex gap-2">
                                <input type="number" id="prodTargetQty" class="flex-1 p-2 border rounded font-bold" placeholder="0" oninput="updatePowderLabel(); calcPkgTotal()">
                                <button onclick="calculateMaxPossible()" class="px-3 bg-orange-100 text-orange-700 rounded font-bold text-xs hover:bg-orange-200 transition">
                                    <i class="fas fa-bolt mr-1"></i> MAX
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="methodB-inputs" class="space-y-4 hidden">
                        <div class="input-group">
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Əsas Xammal (Obrat/Süd)</label>
                            <select id="prodBaseStock" class="w-full p-2 border rounded font-bold bg-slate-50 mb-2"></select>
                            <input type="number" id="prodBaseQty" class="w-full p-2 border rounded font-bold" placeholder="Miqdar (kq)" oninput="updatePowderLabel()">
                        </div>
                    </div>

                    <div class="flex items-center gap-2 bg-slate-50 p-3 rounded">
                        <input type="checkbox" id="usePowder" class="w-5 h-5" onchange="updatePowderLabel()">
                        <label for="usePowder" class="text-sm font-bold text-slate-600">
                            Quru Süd (1 Ton üçün 15 kq) 
                            <span id="lblPowderCalc" class="text-blue-600 ml-1 font-normal"></span>
                        </label>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-bold uppercase text-slate-500">Qablaşma Planı</h4>
                            <button onclick="addPkgRow()" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-2 py-1 rounded font-bold">
                                <i class="fas fa-plus"></i> Əlavə et
                            </button>
                        </div>
                        <div id="pkgContainer" class="space-y-1 max-h-48 overflow-y-auto pr-1"></div>
                        <div class="text-right mt-2 text-xs font-bold text-slate-400" id="pkgResidue">Qalıq: -</div>
                    </div>

                    <button onclick="calculateProduction()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">
                        Planı Hesabla
                    </button>
                </div>

                <div id="prodResultBox" class="bg-slate-800 text-white p-6 rounded-2xl hidden flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-bold mb-1 opacity-80">İstehsal Planı</h3>
                        <h2 id="resProdName" class="text-3xl font-bold mb-6 text-yellow-400">Qatıq</h2>
                        
                        <div class="space-y-4 text-sm">
                            <div class="flex justify-between border-b border-slate-600 pb-2">
                                <span>Ümumi Məhsul:</span>
                                <span id="resTotalQty" class="font-bold text-lg">0 kq</span>
                            </div>
                            <div class="flex justify-between">
                                <span id="resBaseName">Obrat:</span>
                                <span id="resBaseQty" class="font-bold">0 kq</span>
                            </div>
                            <div class="flex justify-between">
                                <span id="resSourceName">Yağlılıq Mənbəyi:</span>
                                <span id="resSourceQty" class="font-bold text-yellow-300">0 kq</span>
                            </div>
                            <div id="resPowderRow" class="flex justify-between hidden">
                                <span>Quru Süd:</span>
                                <span id="resPowderQty" class="font-bold">0 kq</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-600">
                            <h4 class="text-xs uppercase text-slate-400 mb-2">Qablaşma</h4>
                            <div id="resPkgList" class="text-xs space-y-1 text-slate-300"></div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <p class="text-xs text-slate-400 mb-2 text-center">Təsdiqləsəniz stoklar azalacaq və tarixçəyə düşəcək.</p>
                        <button onclick="commitProduction()" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition shadow-lg shadow-green-900/50">
                            <i class="fas fa-play-circle mr-2"></i> İstehsalı Başlat
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-prod_history" class="panel space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">İstehsalat Tarixçəsi</h2>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-green-50 text-xs uppercase font-bold text-green-700">
                        <tr>
                            <th class="p-4">Tarix</th>
                            <th class="p-4">Məhsul</th>
                            <th class="p-4 text-right">Miqdar (kq)</th>
                        </tr>
                    </thead>
                    <tbody id="prodHistoryBody">
                        <tr><td colspan="3" class="p-4 text-center text-slate-400">Yüklənir...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="panel-logs" class="panel space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Ümumi Sistem Logları</h2>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                        <tr>
                            <th class="p-4">Vaxt</th>
                            <th class="p-4">Növ</th>
                            <th class="p-4">Təfərrüat</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="stockModal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold">Stok Əməliyyatı</h3>
                <button onclick="closeStockModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Məhsul</label>
                    <select id="modalStockType" class="w-full p-2 border rounded font-bold bg-slate-50"></select>
                </div>
                <div id="modalFatGroup">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Yağlılıq (%)</label>
                    <input type="number" id="modalStockFat" class="w-full p-2 border rounded font-bold" placeholder="Məs: 50">
                </div>
                <div class="flex gap-2 bg-slate-100 p-1 rounded-lg">
                    <button onclick="setModalMode('add')" id="modeAdd" class="flex-1 py-1 rounded-md text-sm font-bold bg-white shadow text-green-700">Mədaxil (+)</button>
                    <button onclick="setModalMode('waste')" id="modeWaste" class="flex-1 py-1 rounded-md text-sm font-bold text-slate-500">Tullantı (-)</button>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Miqdar (kq)</label>
                    <input type="number" id="modalStockQty" class="w-full p-2 border rounded font-bold text-lg" placeholder="0">
                </div>
                <button onclick="commitStockChange()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Yadda Saxla</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, update, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbP8iq9MB6th3ETqbd5MdTVy3F7c6OOE4",
            authDomain: "serme-erp.firebaseapp.com",
            databaseURL: "https://serme-erp-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "serme-erp",
            storageBucket: "serme-erp.firebasestorage.app",
            messagingSenderId: "376057915689",
            appId: "1:376057915689:web:f1bcdf2edb889963082f38"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let stocks = {};
        let currentModalMode = 'add';
        let prodMethod = 'A';
        let prodCalculation = null;

        const STOCK_TYPES = {
            'milk': { label: 'Üzlü Süd', unit: 'kq', icon: 'fa-glass-water', color: 'blue' },
            'cream_own': { label: 'Daxili Çiyə', unit: 'kq', icon: 'fa-cheese', color: 'yellow' },
            'cream_buy': { label: 'Kənar Çiyə', unit: 'kq', icon: 'fa-cart-flatbed', color: 'orange' },
            'butter': { label: 'Kərə Yağı', unit: 'kq', icon: 'fa-cube', color: 'amber' },
            'skim': { label: 'Obrat (Üzsüz)', unit: 'kq', icon: 'fa-droplet', color: 'slate' },
            'powder': { label: 'Quru Süd', unit: 'kq', icon: 'fa-snowflake', color: 'gray' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initDB();
            initUI();
        });

        function initDB() {
            const stockRef = ref(db, 'stocks');
            onValue(stockRef, (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    stocks = val;
                    // Məcburi: Əgər Obrat gəlirsə, onun yağlılığını 0 et.
                    if(stocks['skim']) stocks['skim'].fat = 0;
                    
                    renderStocks();
                    updateDropdowns();
                    if(stocks['milk'] && stocks['milk'].fat > 0) {
                        document.getElementById('sepInputFat').value = stocks['milk'].fat;
                    }
                    
                    document.getElementById('dbStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> ONLINE';
                    document.getElementById('dbStatus').classList.replace('text-orange-400', 'text-green-600');
                } else {
                    Object.keys(STOCK_TYPES).forEach(key => { if (!stocks[key]) stocks[key] = { qty: 0, fat: 0 }; });
                    renderStocks();
                }
            });

            const logsRef = ref(db, 'logs');
            onValue(logsRef, (snapshot) => { renderLogs(snapshot.val()); });

            // YENİ: İstehsalat tarixçəsini ayrıca oxu
            const prodHistRef = ref(db, 'production_history');
            onValue(prodHistRef, (snapshot) => { renderProductionHistory(snapshot.val()); });
        }

        function initUI() {
            const modalSelect = document.getElementById('modalStockType');
            modalSelect.innerHTML = '';
            Object.keys(STOCK_TYPES).forEach(k => {
                modalSelect.innerHTML += `<option value="${k}">${STOCK_TYPES[k].label}</option>`;
            });
            addPkgRow();
        }

        function renderStocks() {
            const container = document.getElementById('stockContainer');
            container.innerHTML = '';
            Object.keys(STOCK_TYPES).forEach(key => {
                const data = stocks[key] || { qty: 0, fat: 0 };
                const def = STOCK_TYPES[key];
                // Obrat üçün heç vaxt yağ göstərmə (həmişə 0)
                let fatHtml = (data.fat > 0 && key !== 'skim') ? `<span class="bg-${def.color}-100 text-${def.color}-700 text-xs px-2 py-1 rounded-full font-bold">${data.fat}% Yağ</span>` : '';
                
                container.innerHTML += `
                    <div class="stock-card bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between h-32 cursor-pointer" onclick="openStockModal('add', '${key}')">
                        <div class="flex justify-between items-start">
                            <div><h4 class="text-xs font-bold uppercase text-slate-500">${def.label}</h4><div class="mt-1">${fatHtml}</div></div>
                            <div class="w-8 h-8 rounded-lg bg-${def.color}-50 text-${def.color}-600 flex items-center justify-center"><i class="fas ${def.icon}"></i></div>
                        </div>
                        <div><div class="text-2xl font-bold text-slate-800">${parseFloat(data.qty).toFixed(1)} <span class="text-sm text-slate-400">${def.unit}</span></div></div>
                    </div>`;
            });
            document.getElementById('sepStockDisplay').innerText = (stocks['milk']?.qty || 0).toFixed(1);
        }

        function updateDropdowns() {
            const srcSelect = document.getElementById('prodFatSource');
            srcSelect.innerHTML = '';
            ['cream_own', 'cream_buy', 'butter', 'milk'].forEach(key => {
                const s = stocks[key];
                if (s && s.qty > 0) srcSelect.innerHTML += `<option value="${key}" data-fat="${s.fat}">${STOCK_TYPES[key].label} (${s.fat}%) - Stok: ${s.qty}kq</option>`;
            });
            if(srcSelect.innerHTML === '') srcSelect.innerHTML = '<option disabled>Stokda yağ mənbəyi yoxdur</option>';

            const baseSelect = document.getElementById('prodBaseStock');
            baseSelect.innerHTML = '';
            ['skim', 'milk'].forEach(key => {
                const s = stocks[key];
                let f = (key === 'skim') ? 0 : (s?.fat || 0);
                baseSelect.innerHTML += `<option value="${key}" data-fat="${f}">${STOCK_TYPES[key].label} (${f}%) - Stok: ${s?.qty || 0}kq</option>`;
            });
        }

        window.calculateMaxPossible = function() {
            const tFat = parseFloat(document.getElementById('prodTargetFat').value);
            const sourceSelect = document.getElementById('prodFatSource');
            const sourceKey = sourceSelect.value;
            const sFat = parseFloat(sourceSelect.options[sourceSelect.selectedIndex]?.dataset.fat || 0);
            
            const bKey = 'skim';
            const bFat = 0; // OBRAT HƏMİŞƏ 0%
            
            const stockSource = stocks[sourceKey]?.qty || 0;
            const stockBase = stocks[bKey]?.qty || 0;

            if(!tFat || tFat <= bFat || tFat >= sFat) return showToast("Hədəf yağ düzgün deyil", "error");
            if(stockSource <= 0) return showToast("Yağ mənbəyi stoku bitib", "error");
            if(stockBase <= 0) return showToast("Obrat stoku bitib", "error");

            const limitBySource = (stockSource * (sFat - bFat)) / (tFat - bFat);
            const limitByBase = (stockBase * (sFat - bFat)) / (sFat - tFat);
            
            let maxQty = Math.min(limitBySource, limitByBase);
            
            document.getElementById('prodTargetQty').value = Math.floor(maxQty);
            updatePowderLabel();
            calcPkgTotal();
            showToast(`Maksimum potensial: ${Math.floor(maxQty)} kq`, "success");
        };

        window.updatePowderLabel = function() {
            let qty = 0;
            if(document.getElementById('methodA-inputs').classList.contains('hidden')) {
                qty = parseFloat(document.getElementById('prodBaseQty').value) || 0;
            } else {
                qty = parseFloat(document.getElementById('prodTargetQty').value) || 0;
            }

            const lbl = document.getElementById('lblPowderCalc');
            if(qty > 0) {
                const req = (qty / 1000) * 15;
                lbl.innerText = `(~${req.toFixed(2)} kq)`;
            } else {
                lbl.innerText = '';
            }
        };

        // --- YENİLƏNMİŞ QABLAŞDIRMA SƏTRİ (KOMPAKT) ---
        window.addPkgRow = function() {
            const div = document.createElement('div');
            // Gap-1, daha az boşluq
            div.className = "flex gap-1 items-start mb-2 relative"; 
            div.innerHTML = `
                <select class="pkg-type flex-[2] pkg-input border rounded bg-white">
                    <option>Vedrə</option><option>Banka</option><option>Paket</option>
                </select>
                
                <div class="flex-[1.5] relative">
                    <input type="number" class="pkg-size w-full pkg-input border rounded" placeholder="Qr" oninput="calcPkgTotal()">
                    <div class="pkg-max-hint text-[9px] text-blue-500 absolute -bottom-3 left-0 w-full truncate font-bold leading-tight"></div>
                </div>

                <input type="number" class="pkg-count flex-[1.5] pkg-input border rounded" placeholder="Say" oninput="calcPkgTotal()">
                
                <button onclick="this.parentElement.remove(); calcPkgTotal()" class="text-red-500 w-8 h-[34px] flex items-center justify-center hover:bg-red-50 rounded">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.getElementById('pkgContainer').appendChild(div);
        };

        window.calcPkgTotal = function() {
            let totalPkgKg = 0;
            let listHtml = "";
            const rows = document.querySelectorAll('#pkgContainer > div');
            
            rows.forEach(row => {
                const size = parseFloat(row.querySelector('.pkg-size').value) || 0;
                const count = parseFloat(row.querySelector('.pkg-count').value) || 0;
                if(size > 0 && count > 0) {
                    const rowKg = (size * count) / 1000;
                    totalPkgKg += rowKg;
                    const type = row.querySelector('.pkg-type').value;
                    listHtml += `<div class="flex justify-between"><span>${type} ${size}qr x ${count}</span><span>${rowKg.toFixed(1)} kq</span></div>`;
                }
            });

            let targetQty = parseFloat(document.getElementById('prodTargetQty').value);
            if(!targetQty && prodCalculation) targetQty = prodCalculation.totalQty;
            targetQty = targetQty || 0;

            const residue = targetQty - totalPkgKg;

            rows.forEach(row => {
                const sizeInput = row.querySelector('.pkg-size');
                const countInput = row.querySelector('.pkg-count');
                const hintDiv = row.querySelector('.pkg-max-hint');
                
                const size = parseFloat(sizeInput.value) || 0;
                const currentCount = parseFloat(countInput.value) || 0;
                
                if(size > 0 && targetQty > 0) {
                    const currentUsedKg = (size * currentCount) / 1000;
                    const availableForThisRow = residue + currentUsedKg;
                    
                    if(availableForThisRow > 0) {
                        const maxCount = Math.floor((availableForThisRow * 1000) / size);
                        hintDiv.innerText = `Max: ${maxCount} əd.`;
                    } else {
                        hintDiv.innerText = 'Limit!';
                    }
                } else {
                    hintDiv.innerText = '';
                }
            });

            const rEl = document.getElementById('pkgResidue');
            rEl.innerText = `Qalıq: ${residue.toFixed(1)} kq`;
            rEl.className = residue < 0 ? "text-right mt-2 text-xs font-bold text-red-500" : "text-right mt-2 text-xs font-bold text-slate-400";
            
            if(document.getElementById('resPkgList')) document.getElementById('resPkgList').innerHTML = listHtml;
        };

        window.calculateProduction = function() {
            const prodName = document.getElementById('prodName').value;
            const targetFat = parseFloat(document.getElementById('prodTargetFat').value);
            const sourceSelect = document.getElementById('prodFatSource');
            const sourceKey = sourceSelect.value;
            const sourceFat = parseFloat(sourceSelect.options[sourceSelect.selectedIndex]?.dataset.fat || 0);
            const usePowder = document.getElementById('usePowder').checked;

            if(!sourceKey || sourceFat <= 0) return showToast('Düzgün yağ mənbəyi seçilməyib', 'error');
            if(!targetFat || targetFat <= 0) return showToast('Hədəf yağlılıq yazın', 'error');

            let totalQty = 0;
            let baseKey = 'skim';
            let baseFat = 0; // OBRAT HƏMİŞƏ 0%
            let reqBase = 0;
            let reqSource = 0;
            let reqPowder = 0;

            if (prodMethod === 'A') {
                totalQty = parseFloat(document.getElementById('prodTargetQty').value);
                if (!totalQty) return showToast('Miqdar yazın', 'error');
                if (usePowder) reqPowder = (totalQty / 1000) * 15;
                const liquidMass = totalQty - reqPowder;
                if (sourceFat <= targetFat) return showToast('Seçilən yağ mənbəyinin faizi hədəfdən çox olmalıdır!', 'error');
                reqSource = liquidMass * (targetFat - baseFat) / (sourceFat - baseFat);
                reqBase = liquidMass - reqSource;
            } else {
                const baseInputQty = parseFloat(document.getElementById('prodBaseQty').value);
                if (!baseInputQty) return showToast('Əsas xammal miqdarı yazın', 'error');
                const baseSelect = document.getElementById('prodBaseStock');
                baseKey = baseSelect.value;
                if(baseKey === 'skim') baseFat = 0; // Force 0
                else baseFat = parseFloat(baseSelect.options[baseSelect.selectedIndex].dataset.fat || 0);
                
                if (sourceFat <= targetFat) return showToast('Seçilən yağ mənbəyinin faizi hədəfdən çox olmalıdır!', 'error');
                reqSource = baseInputQty * (targetFat - baseFat) / (sourceFat - targetFat);
                reqBase = baseInputQty;
                const liquidTotal = reqBase + reqSource;
                if (usePowder) reqPowder = (liquidTotal / 1000) * 15;
                totalQty = liquidTotal + reqPowder;
            }

            const stockSource = stocks[sourceKey]?.qty || 0;
            const stockBase = stocks[baseKey]?.qty || 0;
            if (reqSource > stockSource) return showToast(`Stokda kifayət qədər ${STOCK_TYPES[sourceKey].label} yoxdur!`, 'error');
            if (baseKey !== 'milk' && reqBase > stockBase) return showToast(`Stokda kifayət qədər ${STOCK_TYPES[baseKey].label} yoxdur!`, 'error');

            prodCalculation = { prodName, totalQty, baseKey, reqBase, sourceKey, reqSource, reqPowder, targetFat };

            document.getElementById('resProdName').innerText = `${prodName} (${targetFat}%)`;
            document.getElementById('resTotalQty').innerText = totalQty.toFixed(2) + " kq";
            document.getElementById('resBaseName').innerText = STOCK_TYPES[baseKey].label + ":";
            document.getElementById('resBaseQty').innerText = reqBase.toFixed(2) + " kq";
            document.getElementById('resSourceName').innerText = STOCK_TYPES[sourceKey].label + ":";
            document.getElementById('resSourceQty').innerText = reqSource.toFixed(2) + " kq";
            
            if (reqPowder > 0) {
                document.getElementById('resPowderRow').classList.remove('hidden');
                document.getElementById('resPowderQty').innerText = reqPowder.toFixed(2) + " kq";
            } else {
                document.getElementById('resPowderRow').classList.add('hidden');
            }
            
            calcPkgTotal();
            document.getElementById('prodResultBox').classList.remove('hidden');
        };

        window.openStockModal = function(mode, preselectKey = null) {
            currentModalMode = mode;
            document.getElementById('stockModal').classList.remove('hidden');
            if(preselectKey) document.getElementById('modalStockType').value = preselectKey;
            
            const modeAddBtn = document.getElementById('modeAdd');
            const modeWasteBtn = document.getElementById('modeWaste');
            const fatGroup = document.getElementById('modalFatGroup');

            if (mode === 'add') {
                modeAddBtn.classList.replace('text-slate-500', 'text-green-700');
                modeAddBtn.classList.replace('bg-slate-100', 'bg-white');
                modeWasteBtn.classList.replace('bg-white', 'bg-slate-100');
                fatGroup.classList.remove('hidden'); 
            } else {
                fatGroup.classList.add('hidden');
            }
        };

        window.setModalMode = function(mode) {
            currentModalMode = mode;
            const modeAddBtn = document.getElementById('modeAdd');
            const modeWasteBtn = document.getElementById('modeWaste');
            const fatGroup = document.getElementById('modalFatGroup');

            if(mode === 'add') {
                modeAddBtn.className = "flex-1 py-1 rounded-md text-sm font-bold bg-white shadow text-green-700";
                modeWasteBtn.className = "flex-1 py-1 rounded-md text-sm font-bold text-slate-500";
                fatGroup.classList.remove('hidden');
            } else {
                modeWasteBtn.className = "flex-1 py-1 rounded-md text-sm font-bold bg-white shadow text-red-700";
                modeAddBtn.className = "flex-1 py-1 rounded-md text-sm font-bold text-slate-500";
                fatGroup.classList.add('hidden');
            }
        };

        window.closeStockModal = function() {
            document.getElementById('stockModal').classList.add('hidden');
            document.getElementById('modalStockQty').value = '';
            document.getElementById('modalStockFat').value = '';
        };

        window.commitStockChange = function() {
            const type = document.getElementById('modalStockType').value;
            const qty = parseFloat(document.getElementById('modalStockQty').value);
            const inputFat = parseFloat(document.getElementById('modalStockFat').value);
            
            if (!qty || qty <= 0) return showToast('Miqdar düzgün deyil', 'error');

            const current = stocks[type] || { qty: 0, fat: 0 };
            let newQty = current.qty;
            let newFat = current.fat;

            if (currentModalMode === 'add') {
                // Əgər obratdırsa fat hesablama, 0 saxla
                if (type !== 'skim' && current.qty > 0 && inputFat && inputFat !== current.fat) {
                    const totalFatMass = (current.qty * current.fat) + (qty * inputFat);
                    newQty = current.qty + qty;
                    newFat = parseFloat((totalFatMass / newQty).toFixed(2));
                } else {
                    newQty += qty;
                    if(type !== 'skim' && inputFat) newFat = inputFat;
                    else if(type === 'skim') newFat = 0;
                }
                logAction('Mədaxil', `${STOCK_TYPES[type].label}: +${qty}kq (${type === 'skim' ? 0 : (inputFat || newFat)}%)`);
            } else {
                if (qty > current.qty) return showToast('Stokda kifayət qədər məhsul yoxdur', 'error');
                newQty -= qty;
                logAction('Tullantı', `${STOCK_TYPES[type].label}: -${qty}kq (İtki)`);
            }

            update(ref(db, `stocks/${type}`), { qty: newQty, fat: newFat })
                .then(() => { showToast('Stok yeniləndi', 'success'); closeStockModal(); });
        };

        let separatorCalcData = null;
        window.calculateSeparator = function() {
            const milkQty = parseFloat(document.getElementById('sepInputMilk').value);
            const milkFat = parseFloat(document.getElementById('sepInputFat').value);
            const loss = parseFloat(document.getElementById('sepInputLoss').value) || 0;
            const creamQty = parseFloat(document.getElementById('sepOutputCream').value);
            const currentStock = stocks['milk']?.qty || 0;

            if (!milkQty || !creamQty) return showToast('Məlumatları tam daxil edin', 'error');
            if (milkQty > currentStock) return showToast('Stokda bu qədər süd yoxdur!', 'error');

            const skimQty = milkQty - creamQty - loss;
            const totalFatIn = (milkQty * milkFat) / 100;
            const fatInSkim = 0; // OBRAT YAĞLILIĞI HƏMİŞƏ 0
            let creamFat = ((totalFatIn - fatInSkim) / creamQty) * 100;
            if (creamFat > 100 || creamFat < 0) creamFat = 0;

            separatorCalcData = { milkUsed: milkQty, creamAdd: creamQty, creamFat: parseFloat(creamFat.toFixed(2)), skimAdd: skimQty, loss: loss };

            document.getElementById('sepResCreamFat').innerText = creamFat.toFixed(2) + "%";
            document.getElementById('sepResSkimQty').innerText = skimQty.toFixed(2) + " kq";
            document.getElementById('sepResultBox').classList.remove('hidden');
        };

        window.commitSeparator = function() {
            if(!separatorCalcData) return;
            const updates = {};
            const curMilk = stocks['milk'] || {qty:0, fat:0};
            updates['stocks/milk/qty'] = curMilk.qty - separatorCalcData.milkUsed;

            const curCream = stocks['cream_own'] || {qty:0, fat:0};
            const newCreamQty = curCream.qty + separatorCalcData.creamAdd;
            const totalCreamFat = (curCream.qty * curCream.fat) + (separatorCalcData.creamAdd * separatorCalcData.creamFat);
            const newCreamFat = newCreamQty > 0 ? (totalCreamFat / newCreamQty) : 0;
            
            updates['stocks/cream_own'] = { qty: newCreamQty, fat: parseFloat(newCreamFat.toFixed(2)) };
            const curSkim = stocks['skim'] || {qty:0, fat:0};
            updates['stocks/skim'] = { qty: curSkim.qty + separatorCalcData.skimAdd, fat: 0 }; // HƏMİŞƏ 0

            update(ref(db), updates).then(() => {
                logAction('Seperasiya', `Süd: -${separatorCalcData.milkUsed}kq > Çiyə: +${separatorCalcData.creamAdd}kq`);
                showToast('Seperasiya tamamlandı', 'success');
                document.getElementById('sepResultBox').classList.add('hidden');
            });
        };

        window.setProdMethod = function(m) {
            prodMethod = m;
            document.getElementById('btnMethodA').className = m === 'A' ? "flex-1 py-3 px-4 rounded-xl border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold transition" : "flex-1 py-3 px-4 rounded-xl border-2 border-transparent bg-white text-slate-600 font-bold hover:bg-slate-50 transition";
            document.getElementById('btnMethodB').className = m === 'B' ? "flex-1 py-3 px-4 rounded-xl border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold transition" : "flex-1 py-3 px-4 rounded-xl border-2 border-transparent bg-white text-slate-600 font-bold hover:bg-slate-50 transition";
            
            if(m === 'A') {
                document.getElementById('methodA-inputs').classList.remove('hidden');
                document.getElementById('methodB-inputs').classList.add('hidden');
            } else {
                document.getElementById('methodA-inputs').classList.add('hidden');
                document.getElementById('methodB-inputs').classList.remove('hidden');
            }
            document.getElementById('prodResultBox').classList.add('hidden');
            updatePowderLabel();
        };

        window.commitProduction = function() {
            if (!prodCalculation) return;
            const updates = {};
            const curBase = stocks[prodCalculation.baseKey] || {qty:0};
            updates[`stocks/${prodCalculation.baseKey}/qty`] = curBase.qty - prodCalculation.reqBase;
            const curSource = stocks[prodCalculation.sourceKey] || {qty:0};
            updates[`stocks/${prodCalculation.sourceKey}/qty`] = curSource.qty - prodCalculation.reqSource;
            if (prodCalculation.reqPowder > 0) {
                const curPow = stocks['powder'] || {qty:0};
                updates[`stocks/powder/qty`] = curPow.qty - prodCalculation.reqPowder;
            }
            
            // YENİ: İstehsalat Tarixçəsinə yaz
            const newProdKey = push(ref(db, 'production_history')).key;
            updates[`production_history/${newProdKey}`] = {
                date: Date.now(),
                name: prodCalculation.prodName,
                qty: parseFloat(prodCalculation.totalQty.toFixed(2)),
                fat: prodCalculation.targetFat
            };

            update(ref(db), updates).then(() => {
                logAction('İstehsal', `${prodCalculation.prodName} (${prodCalculation.totalQty.toFixed(1)}kq) istehsal edildi.`);
                showToast('İstehsal təsdiqləndi', 'success');
                document.getElementById('prodResultBox').classList.add('hidden');
            });
        };

        function renderProductionHistory(data) {
            const tbody = document.getElementById('prodHistoryBody');
            if (!data) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400">Tarixçə yoxdur</td></tr>'; return; }
            const list = Object.values(data).sort((a,b) => b.date - a.date);
            let html = '';
            list.forEach(item => {
                const date = new Date(item.date).toLocaleString('az-AZ');
                html += `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="p-4 text-slate-500">${date}</td>
                        <td class="p-4 font-bold text-slate-700">${item.name} <span class="text-xs text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full">${item.fat}%</span></td>
                        <td class="p-4 text-right font-mono font-bold">${item.qty}</td>
                    </tr>`;
            });
            tbody.innerHTML = html;
        }

        window.showPanel = function(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
        };

        function renderLogs(data) {
            const tbody = document.getElementById('logsTableBody');
            if (!data) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-slate-400">Tarixçə yoxdur</td></tr>'; return; }
            const logs = Object.values(data).sort((a,b) => b.timestamp - a.timestamp).slice(0, 50);
            let html = '';
            logs.forEach(log => {
                const date = new Date(log.timestamp).toLocaleString('az-AZ');
                html += `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="p-4 text-xs text-slate-500">${date}</td><td class="p-4 font-bold text-slate-700">${log.type}</td><td class="p-4">${log.details}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        function logAction(type, details) { push(ref(db, 'logs'), { type: type, details: details, timestamp: Date.now() }); }
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = `fixed top-5 right-5 z-50 transform transition-all duration-300 px-6 py-3 rounded shadow-lg font-bold text-white ${type==='error'?'bg-red-500':'bg-green-500'}`;
            t.innerText = msg;
            t.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => t.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        window.openStockModal = openStockModal;
        window.setModalMode = setModalMode;
        window.closeStockModal = closeStockModal;
        window.commitStockChange = commitStockChange;
        window.calculateSeparator = calculateSeparator;
        window.commitSeparator = commitSeparator;
        window.setProdMethod = setProdMethod;
        window.calculateProduction = calculateProduction;
        window.commitProduction = commitProduction;
        window.showPanel = showPanel;
        window.addPkgRow = addPkgRow;
        window.calcPkgTotal = calcPkgTotal;
        window.calculateMaxPossible = calculateMaxPossible;
        window.updatePowderLabel = updatePowderLabel;
    </script>
</body>
</html>